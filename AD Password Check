# Import Active Directory module
Import-Module ActiveDirectory

# Define the path to the text file containing email addresses
$EmailListPath = "C:\path\to\email_list.txt"

# Check if file exists
if (!(Test-Path $EmailListPath)) {
    Write-Host "Error: File not found at $EmailListPath" -ForegroundColor Red
    exit
}

# Read email addresses from the file
$RawEmails = Get-Content -Path $EmailListPath

# Extract content between < > brackets using regex
$Emails = $RawEmails | ForEach-Object {
    if ($_ -match "<(.*?)>") { $matches[1] }
} | Where-Object { $_ -ne $null }

# Create an array to store results
$Results = @()

# Loop through each extracted email and check password age
foreach ($Email in $Emails) {
    # Trim whitespace
    $Email = $Email.Trim()

    # Get user details from Active Directory
    $User = Get-ADUser -Filter {EmailAddress -eq $Email} -Properties PasswordLastSet

    if ($User) {
        # Calculate password age
        $PasswordLastSet = $User.PasswordLastSet
        $PasswordAge = (Get-Date) - $PasswordLastSet
        $PasswordAgeDays = [math]::Round($PasswordAge.TotalDays, 0)

        # Store results in array
        $Results += [PSCustomObject]@{
            Email = $Email
            PasswordAgeDays = $PasswordAgeDays
        }
    } else {
        Write-Host "User not found: $Email" -ForegroundColor Yellow
    }
}

# Group and sort results
$OlderPasswords = $Results | Where-Object { $_.PasswordAgeDays -ge 7 } | Sort-Object -Property Email
$NewerPasswords = $Results | Where-Object { $_.PasswordAgeDays -le 6 } | Sort-Object -Property Email

# Display grouped and sorted results
Write-Host "`n========== PASSWORD AGE: 7+ DAYS ==========" -ForegroundColor Red
foreach ($Result in $OlderPasswords) {
    Write-Host "User: $($Result.Email) | Password Age: " -NoNewline
    Write-Host "$($Result.PasswordAgeDays) days" -ForegroundColor Red
}

Write-Host "`n========== PASSWORD AGE: 6 OR FEWER DAYS ==========" -ForegroundColor Green
foreach ($Result in $NewerPasswords) {
    Write-Host "User: $($Result.Email) | Password Age: " -NoNewline
    Write-Host "$($Result.PasswordAgeDays) days" -ForegroundColor Green
}